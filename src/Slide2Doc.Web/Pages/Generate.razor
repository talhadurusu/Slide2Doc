@page "/generate"
@inject AppState AppState
@inject ICompileDocumentService CompileService
@inject IJSRuntime JsRuntime
@inject ILogger<Generate> Logger

<h1>Generate</h1>
<p>Create the compiled DOCX using the current mappings.</p>

@if (!string.IsNullOrEmpty(_message))
{
    <div>@_message</div>
}

<button @onclick="GenerateAsync" disabled="@_isBusy">Generate &amp; Download</button>

@code {
    private bool _isBusy;
    private string? _message;

    private async Task GenerateAsync()
    {
        if (!AppState.Matches.Any() || !AppState.Sources.Any())
        {
            _message = "No matches available. Upload files first.";
            return;
        }

        try
        {
            _isBusy = true;
            _message = null;
            var stream = await CompileService.ComposeAsync(AppState.Matches, AppState.Sources, AppState.Options, CancellationToken.None);
            if (stream is MemoryStream ms)
            {
                var base64 = Convert.ToBase64String(ms.ToArray());
                await JsRuntime.InvokeVoidAsync("downloadFile", AppState.Options.OutputFileName, "application/vnd.openxmlformats-officedocument.wordprocessingml.document", base64);
                _message = "Document generated.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate file");
            _message = "Generation failed. Please try again.";
        }
        finally
        {
            _isBusy = false;
        }
    }
}
